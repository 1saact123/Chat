<!DOCTYPE html>
<html>
<head>
    <title>Widget REST + WebSocket</title>
    <script src="https://chat.movonte.com/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .connecting { background: #fff3cd; color: #856404; }
        
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.assistant {
            background: #28a745;
            color: white;
        }
        
        .message.system {
            background: #6c757d;
            color: white;
            text-align: center;
            font-style: italic;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .input-group button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .input-group button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üéØ Widget REST + WebSocket</h1>
    
    <div id="status" class="status connecting">Conectando...</div>
    
    <div class="chat-container">
        <h3>üí¨ Chat Widget</h3>
        <div id="messages"></div>
        
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." disabled>
            <button id="sendBtn" onclick="sendMessage()" disabled>Enviar</button>
        </div>
        
        <div class="ticket-controls" style="margin-top: 10px; text-align: center;">
            <button onclick="clearTicketAndCreateNew()" style="background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                üóëÔ∏è Nueva Conversaci√≥n
            </button>
        </div>
        
        <!-- Configuraci√≥n del Flujo Paralelo -->
        <div class="parallel-flow-config" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
            <h4>üîÑ Configuraci√≥n del Flujo Paralelo</h4>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">URL del Webhook:</label>
                <input type="text" id="webhookUrl" placeholder="https://tu-webhook-url.com/endpoint" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ID del Asistente (opcional):</label>
                <input type="text" id="assistantId" placeholder="asst-xxxxx" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button onclick="configureParallelFlow()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    üîß Configurar Flujo Paralelo
                </button>
                <button onclick="testWebhook()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    üß™ Probar Webhook
                </button>
                <button onclick="getParallelFlowStats()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    üìä Estad√≠sticas
                </button>
            </div>
            <div id="parallelFlowStatus" style="font-size: 12px; color: #666;"></div>
        </div>
    </div>
    
    <div class="logs">
        <h4>üìã Logs del Sistema</h4>
        <div id="logs"></div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;
        let currentTicket = null;
        
        // üîê FUNCIONES DE ENCRIPTACI√ìN/DESENCRIPTACI√ìN
        const ENCRYPTION_KEY = 'movonte-widget-2024'; // Clave de encriptaci√≥n
        
        // Funci√≥n para encriptar datos
        function encryptData(data) {
            try {
                const jsonString = JSON.stringify(data);
                const encoded = btoa(unescape(encodeURIComponent(jsonString)));
                return encoded;
            } catch (error) {
                console.error('Error encriptando datos:', error);
                return null;
            }
        }
        
        // Funci√≥n para desencriptar datos
        function decryptData(encryptedData) {
            try {
                const decoded = decodeURIComponent(escape(atob(encryptedData)));
                return JSON.parse(decoded);
            } catch (error) {
                console.error('Error desencriptando datos:', error);
                return null;
            }
        }
        
        // Funci√≥n para guardar ticket encriptado en localStorage
        function saveEncryptedTicket(ticketData) {
            try {
                const encryptedTicket = encryptData({
                    ticketId: ticketData.ticketId,
                    timestamp: Date.now(),
                    expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 d√≠as
                });
                
                if (encryptedTicket) {
                    localStorage.setItem('movonte_widget_ticket', encryptedTicket);
                    log('üíæ Ticket guardado encriptado en localStorage');
                    return true;
                }
            } catch (error) {
                console.error('Error guardando ticket:', error);
            }
            return false;
        }
        
        // Funci√≥n para recuperar ticket encriptado de localStorage
        function loadEncryptedTicket() {
            try {
                const encryptedTicket = localStorage.getItem('movonte_widget_ticket');
                if (!encryptedTicket) {
                    log('üì≠ No hay ticket guardado en localStorage');
                    return null;
                }
                
                const ticketData = decryptData(encryptedTicket);
                if (!ticketData) {
                    log('‚ùå Error desencriptando ticket');
                    return null;
                }
                
                // Verificar si el ticket ha expirado
                if (Date.now() > ticketData.expiresAt) {
                    log('‚è∞ Ticket expirado, eliminando...');
                    localStorage.removeItem('movonte_widget_ticket');
                    return null;
                }
                
                log('‚úÖ Ticket recuperado de localStorage:', ticketData);
                return ticketData;
            } catch (error) {
                console.error('Error cargando ticket:', error);
                return null;
            }
        }
        
        // Funci√≥n para limpiar ticket de localStorage
        function clearEncryptedTicket() {
            localStorage.removeItem('movonte_widget_ticket');
            log('üóëÔ∏è Ticket eliminado de localStorage');
        }
        
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const logsDiv = document.getElementById('logs');
        
        // Inicializar conexi√≥n WebSocket
        function initWebSocket() {
            log('üîå Conectando WebSocket para recibir respuestas...');
            socket = io('https://chat.movonte.com');
            
            socket.on('connect', () => {
                log('‚úÖ WebSocket conectado - Listo para recibir respuestas de IA');
                statusDiv.innerHTML = '‚úÖ Conectado - Listo para recibir respuestas';
                statusDiv.className = 'status connected';
                isConnected = true;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                addMessage('system', 'Conectado al chat en tiempo real');
                
                // üéØ UNIRSE A LA SALA DEL TICKET ESPEC√çFICO
                if (currentTicket) {
                    socket.emit('join-ticket', currentTicket);
                    log(`üé´ Uni√©ndose al ticket: ${currentTicket}`);
                }
            });
            
            socket.on('disconnect', () => {
                log('‚ùå WebSocket desconectado');
                statusDiv.innerHTML = '‚ùå Desconectado del WebSocket';
                statusDiv.className = 'status disconnected';
                isConnected = false;
                messageInput.disabled = true;
                sendBtn.disabled = true;
                addMessage('system', 'Desconectado del chat');
            });
            
            // üéØ RECIBIR RESPUESTAS DE IA VIA WEBSOCKET
            socket.on('ai-response', (data) => {
                log('ü§ñ Respuesta de IA recibida:', data);
                addMessage('assistant', data.message);
            });
            
            // üéØ RECIBIR COMENTARIOS DE JIRA (IA Y AGENTES)
            socket.on('jira-comment', (data) => {
                log('üí¨ Comentario de Jira recibido:', data);
                
                // Filtrar mensajes del widget (Chat User)
                if (data.author === 'Chat User') {
                    log('üö´ Mensaje del widget filtrado:', data.message);
                    return; // No mostrar mensajes del widget
                }
                
                if (data.isAI) {
                    // Es un comentario de IA
                    addMessage('assistant', data.message);
                } else {
                    // Es un comentario de agente
                    addMessage('system', `${data.author}: ${data.message}`);
                }
            });
            
            socket.on('error', (error) => {
                log('‚ùå Error WebSocket:', error);
                addMessage('system', `Error: ${error.message}`);
            });
        }
        
        // Enviar mensaje via REST API
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            if (!currentTicket) {
                log('‚ùå No hay ticket disponible');
                addMessage('system', 'Error: No hay ticket disponible');
                return;
            }
            
            log('üì§ Enviando mensaje via REST API...');
            log('üé´ Current ticket:', currentTicket);
            addMessage('user', message);
            
            try {
                // Usar endpoint REST normal del widget
                const response = await fetch('https://chat.movonte.com/api/widget/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        issueKey: currentTicket,
                        customerInfo: {
                            name: 'Widget User',
                            email: 'widget@movonte.com'
                        }
                    })
                });
                
                const result = await response.json();
                
                        if (result.success) {
                            log('‚úÖ Mensaje enviado exitosamente:', result);
                            // No mostrar mensaje de confirmaci√≥n al usuario
                        } else {
                            log('‚ùå Error enviando mensaje:', result);
                            addMessage('system', `Error: ${result.error}`);
                        }
                
            } catch (error) {
                log('‚ùå Error en la petici√≥n:', error);
                addMessage('system', `Error: ${error.message}`);
            }
            
            messageInput.value = '';
        }
        
        // Crear ticket inicial
        async function createInitialTicket() {
            log('üé´ Creando ticket inicial...');
            
            try {
                const response = await fetch('https://chat.movonte.com/api/landing/create-ticket', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: 'Widget User',
                        email: 'widget@movonte.com',
                        message: 'Widget Chat iniciado',
                        source: 'widget'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTicket = result.jiraIssue.key;
                    log('‚úÖ Ticket creado:', result);
                    addMessage('system', `Ticket creado: ${currentTicket}`);
                    
                    // üîê GUARDAR TICKET ENCRIPTADO EN LOCALSTORAGE
                    const ticketData = {
                        ticketId: currentTicket,
                        jiraIssue: result.jiraIssue,
                        timestamp: Date.now()
                    };
                    
                    if (saveEncryptedTicket(ticketData)) {
                        log('üíæ Ticket guardado encriptado para persistencia');
                    }
                    
                    // üéØ UNIRSE A LA SALA DEL TICKET SI YA EST√Å CONECTADO
                    if (socket && isConnected) {
                        socket.emit('join-ticket', currentTicket);
                        log(`üé´ Uni√©ndose al ticket: ${currentTicket}`);
                    }
                } else {
                    log('‚ùå Error creando ticket:', result);
                    addMessage('system', `Error: ${result.error}`);
                }
                
            } catch (error) {
                log('‚ùå Error creando ticket:', error);
                addMessage('system', `Error: ${error.message}`);
            }
        }
        
        // Agregar mensaje al chat
        function addMessage(type, content) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = content;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Agregar log
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            if (data) {
                logEntry.innerHTML += `<br><small>${JSON.stringify(data, null, 2)}</small>`;
            }
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        // Event listeners
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Funci√≥n para intentar recuperar ticket existente
        async function tryRecoverTicket() {
            const savedTicket = loadEncryptedTicket();
            if (savedTicket && savedTicket.ticketId) {
                log('üîÑ Intentando recuperar ticket existente:', savedTicket.ticketId);
                currentTicket = savedTicket.ticketId;
                
                // Unirse a la sala del ticket si ya est√° conectado
                if (socket && isConnected) {
                    socket.emit('join-ticket', currentTicket);
                    log(`üé´ Reuni√©ndose al ticket: ${currentTicket}`);
                }
                
                addMessage('system', `Conversaci√≥n recuperada: ${currentTicket}`);
                return true;
            }
            return false;
        }
        
        // Funci√≥n para limpiar ticket y crear uno nuevo
        async function clearTicketAndCreateNew() {
            log('üóëÔ∏è Limpiando ticket actual y creando uno nuevo...');
            
            // Limpiar ticket actual
            clearEncryptedTicket();
            currentTicket = null;
            
            // Limpiar mensajes del chat
            messagesDiv.innerHTML = '';
            
            // Crear nuevo ticket
            await createInitialTicket();
            
            addMessage('system', 'Nueva conversaci√≥n iniciada');
        }
        
        // üîÑ FUNCIONES DEL FLUJO PARALELO
        async function configureParallelFlow() {
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            const assistantId = document.getElementById('assistantId').value.trim();
            
            if (!webhookUrl) {
                updateParallelFlowStatus('‚ùå URL del webhook es requerida', 'error');
                return;
            }
            
            try {
                log('üîß Configurando flujo paralelo...');
                updateParallelFlowStatus('‚è≥ Configurando...', 'info');
                
                const response = await fetch('https://chat.movonte.com/api/chatbot/parallel-flow/configure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: true,
                        webhookUrl: webhookUrl,
                        assistantId: assistantId || undefined,
                        timeout: 10000
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log('‚úÖ Flujo paralelo configurado exitosamente');
                    updateParallelFlowStatus('‚úÖ Flujo paralelo configurado', 'success');
                } else {
                    log('‚ùå Error configurando flujo paralelo:', result.error);
                    updateParallelFlowStatus(`‚ùå Error: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log('‚ùå Error en configuraci√≥n:', error);
                updateParallelFlowStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function testWebhook() {
            try {
                log('üß™ Probando webhook...');
                updateParallelFlowStatus('‚è≥ Probando webhook...', 'info');
                
                const response = await fetch('https://chat.movonte.com/api/chatbot/parallel-flow/test-webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log('‚úÖ Webhook funcionando correctamente');
                    updateParallelFlowStatus('‚úÖ Webhook funcionando', 'success');
                } else {
                    log('‚ùå Error en webhook:', result.error);
                    updateParallelFlowStatus(`‚ùå Error: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log('‚ùå Error probando webhook:', error);
                updateParallelFlowStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function getParallelFlowStats() {
            try {
                log('üìä Obteniendo estad√≠sticas...');
                updateParallelFlowStatus('‚è≥ Obteniendo estad√≠sticas...', 'info');
                
                const response = await fetch('https://chat.movonte.com/api/chatbot/parallel-flow/stats');
                const result = await response.json();
                
                if (result.success) {
                    log('üìä Estad√≠sticas del flujo paralelo:', result.stats);
                    updateParallelFlowStatus(`üìä Habilitado: ${result.stats.enabled}, Webhook: ${result.stats.webhookConfigured}, Threads: ${result.stats.totalThreads || 0}`, 'info');
                } else {
                    log('‚ùå Error obteniendo estad√≠sticas:', result.error);
                    updateParallelFlowStatus(`‚ùå Error: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log('‚ùå Error obteniendo estad√≠sticas:', error);
                updateParallelFlowStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function updateParallelFlowStatus(message, type) {
            const statusDiv = document.getElementById('parallelFlowStatus');
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            log('üöÄ Iniciando widget REST + WebSocket...');
            
            // 1. Conectar WebSocket primero
            initWebSocket();
            
            // 2. Intentar recuperar ticket existente
            const ticketRecovered = await tryRecoverTicket();
            if (!ticketRecovered) {
                // 3. Si no hay ticket guardado, crear uno nuevo
                await createInitialTicket();
            }
        });
    </script>
</body>
</html>
