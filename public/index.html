<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Control Panel - Movonte</title>
    <link rel="icon" type="image/x-icon" href="favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png">
    <link rel="stylesheet" href="ceo-dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .global-assistant-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .global-assistant-info .info-label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .global-assistant-info .info-value {
            font-size: 16px;
            font-weight: 600;
        }

        .status-disable-config-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .status-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .status-checkbox {
            margin-right: 8px;
        }

        .status-label {
            font-size: 14px;
            cursor: pointer;
        }

        /* Section Navigation Styles */
        .section-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 0;
        }

        .section-nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }

        .section-nav-btn {
            background: none;
            border: none;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-nav-btn:hover {
            color: #495057;
            background: #e9ecef;
        }

        .section-nav-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: white;
        }

        .section-nav-btn i {
            font-size: 16px;
        }

        /* Section Content */
        .main-container .section-content {
            display: none !important;
        }

        .main-container .section-content.active {
            display: block !important;
        }

        /* Header Logo Styles */
        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 6px;
        }

        .header-title h1 {
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="favicons/favicon-32x32.png" alt="Movonte Logo" class="brand-logo">
                <span class="brand-text">Movonte</span>
            </div>
            <div class="nav-links">
                <a href="#" class="nav-link">Dashboard</a>
                <a href="#" class="nav-link">Assistants</a>
                <a href="#" class="nav-link">Services</a>
                <a href="#" class="nav-link active">Settings</a>
                <button id="logoutBtn" class="nav-link logout-btn" style="background: none; border: none; color: inherit; cursor: pointer; font-size: inherit;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Section Navigation -->
    <div class="section-nav">
        <div class="section-nav-container">
            <button class="section-nav-btn active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="section-nav-btn" data-section="assistants">
                <i class="fas fa-robot"></i> Assistants
            </button>
            <button class="section-nav-btn" data-section="services">
                <i class="fas fa-cogs"></i> Services
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section-content active">
            <!-- Page Header -->
            <div class="page-header">
                <div class="header-content">
                    <div class="header-title">
                        <img src="favicons/favicon-32x32.png" alt="Movonte Logo" class="header-logo">
                        <h1>AI Assistant Control Panel</h1>
                    </div>
                    <p>Manage your AI assistants, configure services, and monitor system activity</p>
                </div>
            </div>

        <!-- Statistics Cards -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="stat-content">
                <div class="stat-number" id="totalAssistants">-</div>
                    <div class="stat-label">AVAILABLE ASSISTANTS</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="totalServices">2</div>
                    <div class="stat-label">CONFIGURED SERVICES</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="stat-content">
                <div class="stat-number" id="activeServices">-</div>
                    <div class="stat-label">ACTIVE SERVICES</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="systemUptime">98.5%</div>
                    <div class="stat-label">SYSTEM UPTIME</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- AI Assistants Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>AI Assistants</h2>
                    </div>
                    <div class="section-content">
                        <!-- Global Active Assistant Info -->
                        <div class="global-assistant-info">
                            <div class="info-label">Global Active Assistant:</div>
                            <div class="info-value" id="globalAssistantName">-</div>
                        </div>
                        
                        <div id="assistantsList" class="assistant-list">
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Loading assistants...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Project Management Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Project Management</h2>
                    </div>
                    <div class="section-content">
                                        <div class="form-group">
                            <label for="activeProject" class="form-label">Active Jira Project</label>
                            <select id="activeProject" class="form-select">
                                <option value="">Loading projects...</option>
                            </select>
                        </div>
                        <div class="project-info">
                            <div class="info-row">
                                <span class="info-label">Current Project:</span>
                                <span class="info-value" id="currentProjectName">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Project Key:</span>
                                <span class="info-value" id="currentProjectKey">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Remote Server Project Management Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Remote Server Project</h2>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="remoteServerUrl" class="form-label">Remote Server URL</label>
                            <input type="text" id="remoteServerUrl" class="form-input" 
                                   placeholder="https://form.movonte.com" 
                                   value="https://form.movonte.com">
                        </div>
                        
                    <div class="form-group">
                            <label for="remoteActiveProject" class="form-label">Remote Active Project</label>
                            <select id="remoteActiveProject" class="form-select">
                                <option value="">Loading remote projects...</option>
                            </select>
                        </div>
                        
                        <div class="remote-project-info">
                            <div class="info-row">
                                <span class="info-label">Remote Current Project:</span>
                                <span class="info-value" id="remoteCurrentProjectName">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Remote Project Key:</span>
                                <span class="info-value" id="remoteCurrentProjectKey">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Service Configuration Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Service Configuration</h2>
                    </div>
                    <div class="section-content">
                        <!-- Landing Page Service -->
                        <div class="service-config">
                            <div class="service-header">
                                <div class="service-info">
                                    <div class="service-name">Landing Page</div>
                                    <div class="service-details">
                                        <div class="detail-row">
                                            <span class="detail-label">Current Assistant:</span>
                                            <span class="detail-value" id="landing-assistant-name">-</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Service ID:</span>
                                            <span class="detail-value">landing-page</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Jira Project:</span>
                                            <span class="detail-value" id="landing-project">-</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Last Updated:</span>
                                            <span class="detail-value" id="landing-last-updated">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="service-controls">
                                <div class="control-section">
                                    <label class="control-label">CHANGE ASSISTANT</label>
                                    <select class="control-select" id="assistant-landing-page">
                                        <option value="">Select an assistant...</option>
                                    </select>
                                </div>
                                <div class="control-buttons">
                                    <button class="btn btn-primary apply-change-btn" data-service-id="landing-page">
                                        APPLY
                                    </button>
                                    <button class="btn btn-secondary toggle-service-btn" 
                                            data-service-id="landing-page" data-is-active="false">
                                        DEACTIVATE
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Status-Based Disable Configuration Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Status-Based AI Control</h2>
                        <p>Automatically disable AI when tickets change to specific statuses</p>
                    </div>
                    <div class="section-content">
                        <!-- Status-Based Disable Configuration -->
                        <div class="status-disable-config-form">
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="statusDisableEnabled">
                                    <span class="checkmark"></span>
                                    Enable automatic AI disable based on ticket status
                                </label>
                            </div>
                            <div class="form-group" id="statusSelectionGroup" style="display: none;">
                                <label for="triggerStatuses" class="form-label">Select Statuses to Trigger AI Disable</label>
                                <div id="statusCheckboxes" class="status-checkboxes">
                                    <!-- Status checkboxes will be populated here -->
                                </div>
                                <small class="form-help">AI will be automatically disabled when tickets change to any of these statuses</small>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" id="saveStatusDisableBtn">Save Configuration</button>
                                <button type="button" class="btn btn-secondary" id="loadStatusDisableBtn">Load Current Config</button>
                            </div>
                        </div>
                        <div class="status-info">
                            <div class="info-item">
                                <span class="info-label">Status-Based Disable:</span>
                                <span id="statusDisableStatus" class="info-value">Not configured</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Trigger Statuses:</span>
                                <span id="triggerStatusesList" class="info-value">None</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Webhook Configuration Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Webhook Configuration</h2>
                        <p>Configure parallel webhook flow for external integrations</p>
                    </div>
                    <div class="section-content">
                        <!-- Webhook URL Configuration -->
                        <div class="webhook-config-form">
                            <div class="form-group">
                                <label for="savedWebhookSelect" class="form-label">Select Saved Webhook</label>
                                <select id="savedWebhookSelect" class="form-select">
                                    <option value="">Choose a saved webhook...</option>
                                </select>
                                <small class="form-help">Select from previously saved webhook URLs</small>
                            </div>
                            <div class="form-group">
                                <label for="webhookUrl" class="form-label">Jira Automation Webhook URL</label>
                                <input type="url" id="webhookUrl" class="form-input" 
                                       placeholder="https://api-private.atlassian.com/automation/webhooks/jira/a/..."
                                       value="">
                                <small class="form-help">URL del webhook de Jira Automation (formato: api-private.atlassian.com/automation/webhooks/...)</small>
                            </div>
                            <div class="form-group" id="newWebhookFields" style="display: none;">
                                <label for="webhookName" class="form-label">Webhook Name (for saving)</label>
                                <input type="text" id="webhookName" class="form-input" 
                                       placeholder="e.g., Jira Production Webhook"
                                       value="">
                                <small class="form-help">Give this webhook a name to save it for future use</small>
                            </div>
                            <div class="form-group" id="newWebhookDescription" style="display: none;">
                                <label for="webhookDescription" class="form-label">Description (optional)</label>
                                <textarea id="webhookDescription" class="form-input" rows="2" 
                                          placeholder="Brief description of this webhook..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="webhookAssistant" class="form-label">Webhook Assistant</label>
                                <select id="webhookAssistant" class="form-select">
                                    <option value="">Select an assistant for webhook flow...</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-info" id="createNewWebhookBtn">
                                    <i class="fas fa-plus"></i> Create New Webhook
                                </button>
                                <button class="btn btn-success" id="saveWebhookBtn" style="display: none;">
                                    <i class="fas fa-bookmark"></i> Save Webhook
                                </button>
                                <button class="btn btn-primary" id="saveWebhookConfigBtn">
                                    <i class="fas fa-save"></i> Save Webhook Configuration
                                </button>
                                <button class="btn btn-secondary" id="testWebhookBtn">
                                    <i class="fas fa-test-tube"></i> Test Webhook
                                </button>
                                <button class="btn btn-warning" id="disableWebhookBtn">
                                    <i class="fas fa-ban"></i> Disable Webhook
                                </button>
                                <button class="btn btn-danger" id="deleteWebhookBtn" style="display: none;">
                                    <i class="fas fa-trash"></i> Delete Saved Webhook
                                </button>
                                <button class="btn btn-secondary" id="cancelNewWebhookBtn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>

                        <!-- Webhook Status -->
                        <div class="webhook-status">
                            <div class="info-row">
                                <span class="info-label">Webhook Status:</span>
                                <span class="info-value" id="webhookStatus">Not configured</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Webhook Type:</span>
                                <span class="info-value" id="webhookType">Jira Automation</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Last Test:</span>
                                <span class="info-value" id="webhookLastTest">Never</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Token Status:</span>
                                <span class="info-value" id="webhookTokenStatus">Not configured</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ticket Control Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Ticket Control</h2>
                        <p>Disable AI assistant for specific Jira tickets</p>
                    </div>
                    <div class="section-content">
                        <!-- Disable Assistant Form -->
                        <div class="ticket-control-form">
                            <div class="form-group">
                                <label for="ticketIssueKey" class="form-label">Jira Ticket Key</label>
                                <input type="text" id="ticketIssueKey" class="form-input" 
                                       placeholder="e.g., TI-123" required>
                            </div>
                            <div class="form-group">
                                <label for="disableReason" class="form-label">Reason (Optional)</label>
                                <textarea id="disableReason" class="form-textarea" 
                                          placeholder="Reason for disabling the AI assistant..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-danger" id="disableTicketBtn">
                                    <i class="fas fa-ban"></i> Disable Assistant
                                </button>
                                <button class="btn btn-success" id="enableTicketBtn">
                                    <i class="fas fa-check"></i> Enable Assistant
                                </button>
                                <button class="btn btn-secondary" id="checkTicketBtn">
                                    <i class="fas fa-search"></i> Check Status
                                </button>
                            </div>
                        </div>

                        <!-- Disabled Tickets List -->
                        <div class="disabled-tickets-section">
                            <div class="section-subheader">
                                <h3>Currently Disabled Tickets</h3>
                                <button class="btn btn-sm btn-secondary" id="refreshDisabledBtn">
                                    <i class="fas fa-refresh"></i> Refresh
                                </button>
                            </div>
                            <div id="disabledTicketsList" class="disabled-tickets-list">
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading disabled tickets...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="activity-section">
            <div class="section-card">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-file-alt"></i>
                        Recent Activity
                    </h2>
                </div>
                <div class="section-content">
                    <div id="recentActivity" class="activity-list">
                        <div class="activity-item">
                            <div class="activity-indicator success"></div>
                            <div class="activity-content">
                                <div class="activity-text">Landing Page service updated successfully with Chatbot Test V3</div>
                                <div class="activity-time">Today at 11:08 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator success"></div>
                            <div class="activity-content">
                                <div class="activity-text">Jira Integration service has been activated</div>
                                <div class="activity-time">Today at 10:45 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator warning"></div>
                            <div class="activity-content">
                                <div class="activity-text">Performance degradation detected for Chatbot Test V2</div>
                                <div class="activity-time">Today at 09:30 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator info"></div>
                            <div class="activity-content">
                                <div class="activity-text">System backup completed successfully</div>
                                <div class="activity-time">Today at 08:15 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator error"></div>
                            <div class="activity-content">
                                <div class="activity-text">Connection timeout for assistant asst_8ttODMww5jd42lqe4nZ7JjG0</div>
                                <div class="activity-time">Today at 07:22 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator success"></div>
                            <div class="activity-content">
                                <div class="activity-text">New assistant "Chatbot Test V3" has been registered</div>
                                <div class="activity-time">Yesterday at 16:45 PM</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Assistants Section -->
        <div id="assistants-section" class="section-content">
            <div class="page-header">
                <div class="header-content">
                    <div class="header-title">
                        <img src="favicons/favicon-32x32.png" alt="Movonte Logo" class="header-logo">
                        <h1>AI Assistants Management</h1>
                    </div>
                    <p>View and manage all your AI assistants</p>
                </div>
            </div>
            
            <div class="content-grid">
                <div class="left-column">
                    <!-- AI Assistants Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <h2>AI Assistants</h2>
                        </div>
                        <div class="section-content">
                            <!-- Global Active Assistant Info -->
                            <div class="global-assistant-info">
                                <div>
                                    <div class="info-label">Asistente Activo Global:</div>
                                    <div class="info-value" id="globalAssistantName">-</div>
                                </div>
                            </div>
                            
                            <!-- Assistants List -->
                            <div id="assistantsList" class="assistants-list">
                                <!-- Assistants will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services Section -->
        <div id="services-section" class="section-content">
            <div class="page-header">
                <div class="header-content">
                    <div class="header-title">
                        <img src="favicons/favicon-32x32.png" alt="Movonte Logo" class="header-logo">
                        <h1>Services Configuration</h1>
                    </div>
                    <p>Configure webhook integrations and service settings</p>
                </div>
            </div>
            
            <div class="content-grid">
                <div class="left-column">
                    <!-- Webhook Configuration Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <h2>Webhook Configuration</h2>
                            <p>Configure parallel webhook flow for external integrations</p>
                        </div>
                        <div class="section-content">
                            <!-- Webhook URL Configuration -->
                            <div class="webhook-config-form">
                                <div class="form-group">
                                    <label for="savedWebhookSelect" class="form-label">Select Saved Webhook</label>
                                    <select id="savedWebhookSelect" class="form-select">
                                        <option value="">Choose a saved webhook...</option>
                                    </select>
                                    <small class="form-help">Select from previously saved webhook URLs</small>
                                </div>
                                <div class="form-group">
                                    <label for="webhookUrl" class="form-label">Jira Automation Webhook URL</label>
                                    <input type="url" id="webhookUrl" class="form-input" 
                                           placeholder="https://api-private.atlassian.com/automation/webhooks/jira/a/..."
                                           value="">
                                    <small class="form-help">URL del webhook de Jira Automation (formato: api-private.atlassian.com/automation/webhooks/...)</small>
                                </div>
                                <div class="form-group" id="newWebhookFields" style="display: none;">
                                    <label for="webhookName" class="form-label">Webhook Name (for saving)</label>
                                    <input type="text" id="webhookName" class="form-input" 
                                           placeholder="e.g., Jira Production Webhook"
                                           value="">
                                    <small class="form-help">Give this webhook a name to save it for future use</small>
                                </div>
                                <div class="form-group" id="newWebhookDescription" style="display: none;">
                                    <label for="webhookDescription" class="form-label">Description (optional)</label>
                                    <textarea id="webhookDescription" class="form-input" rows="2" 
                                              placeholder="Brief description of this webhook..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="webhookAssistant" class="form-label">Webhook Assistant</label>
                                    <select id="webhookAssistant" class="form-select">
                                        <option value="">Select an assistant for webhook flow...</option>
                                    </select>
                                </div>
                                <div class="form-actions">
                                    <button class="btn btn-info" id="createNewWebhookBtn">
                                        <i class="fas fa-plus"></i> Create New Webhook
                                    </button>
                                    <button class="btn btn-success" id="saveWebhookBtn" style="display: none;">
                                        <i class="fas fa-bookmark"></i> Save Webhook
                                    </button>
                                    <button class="btn btn-primary" id="saveWebhookConfigBtn">
                                        <i class="fas fa-save"></i> Save Webhook Configuration
                                    </button>
                                    <button class="btn btn-secondary" id="testWebhookBtn">
                                        <i class="fas fa-test-tube"></i> Test Webhook
                                    </button>
                                    <button class="btn btn-warning" id="disableWebhookBtn">
                                        <i class="fas fa-ban"></i> Disable Webhook
                                    </button>
                                    <button class="btn btn-danger" id="deleteWebhookBtn" style="display: none;">
                                        <i class="fas fa-trash"></i> Delete Saved Webhook
                                    </button>
                                    <button class="btn btn-secondary" id="cancelNewWebhookBtn" style="display: none;">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>

                            <!-- Webhook Status -->
                            <div class="webhook-status">
                                <div class="info-row">
                                    <span class="info-label">Webhook Status:</span>
                                    <span id="webhookStatus" class="info-value">Not configured</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Webhook Type:</span>
                                    <span id="webhookType" class="info-value">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Last Test:</span>
                                    <span id="webhookLastTest" class="info-value">Never</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Token Status:</span>
                                    <span id="webhookTokenStatus" class="info-value">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status-Based AI Control Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <h2>Status-Based AI Control</h2>
                            <p>Automatically disable AI when tickets change to specific statuses</p>
                        </div>
                        <div class="section-content">
                            <div class="status-disable-config-form">
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" id="statusDisableEnabled">
                                        <span class="checkmark"></span>
                                        Enable automatic AI disable based on ticket status
                                    </label>
                                </div>
                                <div class="form-group" id="statusSelectionGroup" style="display: none;">
                                    <label for="triggerStatuses" class="form-label">Select Statuses to Trigger AI Disable</label>
                                    <div id="statusCheckboxes" class="status-checkboxes">
                                        <!-- Status checkboxes will be populated here -->
                                    </div>
                                    <small class="form-help">AI will be automatically disabled when tickets change to any of these statuses</small>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-primary" id="saveStatusDisableBtn">Save Configuration</button>
                                    <button type="button" class="btn btn-secondary" id="loadStatusDisableBtn">Load Current Config</button>
                                </div>
                            </div>
                            <div class="status-info">
                                <div class="info-item">
                                    <span class="info-label">Status-Based Disable:</span>
                                    <span id="statusDisableStatus" class="info-value">Not configured</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Trigger Statuses:</span>
                                    <span id="triggerStatusesList" class="info-value">None</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>

    <script>
        class CEODashboard {
            constructor() {
                this.assistants = [];
                this.projects = [];
                this.serviceConfigs = [];
                this.activeProject = '';
                this.activeAssistant = '';
                this.remoteProjects = [];
                this.remoteActiveProject = '';
                this.remoteServerUrl = 'https://form.movonte.com';
                this.authToken = localStorage.getItem('authToken');
                this.initialize();
            }

            async initialize() {
                // Verificar autenticaciÃ³n
                if (!this.authToken) {
                    console.log('âŒ No hay token de autenticaciÃ³n, redirigiendo al login');
                    window.location.href = '/login';
                    return;
                }
                
                await this.loadDashboard();
                await this.loadProjects();
                await this.loadRemoteProjects();
                await this.loadDisabledTickets();
                await this.loadSavedWebhooks();
                await this.updateWebhookStatus();
                await this.loadStatusDisableConfig();
                this.setupEventListeners();
                this.setupSectionNavigation();
                
                // Debug: Check initial section state
                console.log('ðŸ” Initial section state:');
                const sections = document.querySelectorAll('.section-content');
                sections.forEach(section => {
                    console.log(`  - ${section.id}: ${section.classList.contains('active') ? 'active' : 'inactive'}`);
                });
            }

            // MÃ©todo para hacer peticiones autenticadas
            async authenticatedFetch(url, options = {}) {
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.authToken}`
                    }
                };
                
                const mergedOptions = {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...options.headers
                    }
                };
                
                try {
                    const response = await fetch(url, mergedOptions);
                    
                    // Si la respuesta es 401, redirigir al login
                    if (response.status === 401) {
                        console.log('âŒ Token invÃ¡lido, redirigiendo al login');
                        localStorage.removeItem('authToken');
                        window.location.href = '/login';
                        return null;
                    }
                    
                    return response;
                } catch (error) {
                    console.error('Error en peticiÃ³n autenticada:', error);
                    throw error;
                }
            }

            async loadDashboard() {
                try {
                    console.log('ðŸ”„ Loading dashboard data...');
                    const response = await this.authenticatedFetch('/api/admin/dashboard');
                    if (!response) return; // Si no hay respuesta (redirigido al login)
                    const data = await response.json();

                    console.log('ðŸ“Š Dashboard data received:', data);

                    if (data.success) {
                        this.assistants = data.data.assistants;
                        this.projects = data.data.projects;
                        this.serviceConfigs = data.data.serviceConfigurations;
                        this.activeProject = data.data.activeProject;
                        this.activeAssistant = data.data.activeAssistant;
                        
                        console.log('âœ… Data loaded:', {
                            assistants: this.assistants.length,
                            projects: this.projects.length,
                            serviceConfigs: this.serviceConfigs.length,
                            activeProject: this.activeProject,
                            activeAssistant: this.activeAssistant
                        });
                        
                        this.updateStats(data.data);
                        this.renderAssistants();
                        this.renderServices();
                        this.renderProjects();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('âŒ Error loading dashboard:', error);
                    this.showStatus(`Error loading dashboard: ${error.message}`, 'error');
                }
            }

            async loadProjects() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/projects');
                    if (!response) return;
                    const data = await response.json();

                    if (data.success) {
                        this.projects = data.projects;
                        this.renderProjects();
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                }
            }

            updateStats(data) {
                document.getElementById('totalAssistants').textContent = data.totalAssistants;
                document.getElementById('activeServices').textContent = 
                    this.serviceConfigs.filter(s => s.isActive && s.serviceId === 'landing-page').length;
            }

            renderAssistants() {
                const container = document.getElementById('assistantsList');
                
                                 if (this.assistants.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-robot"></i><span>No assistants available</span></div>';
                     return;
                 }

                container.innerHTML = this.assistants.map(assistant => {
                    // Determinar el estado del asistente
                    const isActive = assistant.isActive || false;
                    const isGlobalActive = assistant.isGlobalActive || false;
                    
                    // Crear texto de estado simplificado
                    let statusText = 'INACTIVE';
                    if (isActive) {
                        statusText = 'ACTIVE';
                    }
                    
                    return `
                        <div class="assistant-item ${isActive ? 'active' : ''}">
                            <div class="assistant-info">
                         <div class="assistant-name">${assistant.name || 'Unnamed'}</div>
                         <div class="assistant-details">
                                    <span class="assistant-id">ID: ${assistant.id}</span>
                                    <span class="assistant-model">Model: ${assistant.model}</span>
                                </div>
                            </div>
                            <div class="assistant-status">
                                <span class="status-dot ${isActive ? 'active' : 'inactive'}"></span>
                                <span class="status-text ${isActive ? 'active' : 'inactive'}">
                                    ${statusText}
                                </span>
                         </div>
                     </div>
                    `;
                }).join('');
            }

            renderProjects() {
                const select = document.getElementById('activeProject');
                const currentProjectName = document.getElementById('currentProjectName');
                const currentProjectKey = document.getElementById('currentProjectKey');
                
                if (this.projects.length === 0) {
                    select.innerHTML = '<option value="">No projects available</option>';
                     return;
                 }

                select.innerHTML = this.projects.map(project => `
                    <option value="${project.key}" ${project.key === this.activeProject ? 'selected' : ''}>
                        ${project.name} (${project.key})
                    </option>
                `).join('');

                // Update current project info
                const currentProject = this.projects.find(p => p.key === this.activeProject);
                if (currentProject) {
                    currentProjectName.textContent = currentProject.name;
                    currentProjectKey.textContent = currentProject.key;
                } else {
                    currentProjectName.textContent = '-';
                    currentProjectKey.textContent = '-';
                }
            }

            renderServices() {
                // Populate assistant dropdowns
                this.populateServiceAssistantDropdowns();
                
                // Update service information
                this.updateServiceInfo();
                
                // Setup event listeners (only once)
                this.setupDynamicEventListeners();
             }

            populateServiceAssistantDropdowns() {
                // Landing Page dropdown
                const landingSelect = document.getElementById('assistant-landing-page');
                if (landingSelect) {
                    landingSelect.innerHTML = '<option value="">Select an assistant...</option>';
                    
                    console.log('Populating dropdown with assistants:', this.assistants);
                    
                    this.assistants.forEach(assistant => {
                        const option = document.createElement('option');
                        option.value = assistant.id;
                        option.textContent = assistant.name || `Assistant ${assistant.id.slice(0, 8)}`;
                        landingSelect.appendChild(option);
                    });
                }

                // Webhook Assistant dropdown
                const webhookSelect = document.getElementById('webhookAssistant');
                if (webhookSelect) {
                    webhookSelect.innerHTML = '<option value="">Select an assistant...</option>';
                    
                    this.assistants.forEach(assistant => {
                        const option = document.createElement('option');
                        option.value = assistant.id;
                        option.textContent = assistant.name || `Assistant ${assistant.id.slice(0, 8)}`;
                        webhookSelect.appendChild(option);
                    });
                }
            }

            updateServiceInfo() {
                console.log('ðŸ”„ Updating service info...');
                console.log('Service configs:', this.serviceConfigs);
                console.log('Active project:', this.activeProject);
                
                // Find service configurations
                const landingService = this.serviceConfigs.find(s => s.serviceId === 'landing-page');
                console.log('Landing service found:', landingService);
                
                // Update Landing Page service
                if (landingService) {
                    console.log('âœ… Updating landing service info:', landingService);
                    document.getElementById('landing-assistant-name').textContent = landingService.assistantName || '-';
                    document.getElementById('landing-last-updated').textContent = new Date(landingService.lastUpdated).toLocaleString();
                    document.getElementById('landing-project').textContent = this.activeProject || '-';
                    
                    // Set selected assistant
                    const landingSelect = document.getElementById('assistant-landing-page');
                    if (landingSelect) {
                        landingSelect.value = landingService.assistantId || '';
                        console.log('Set dropdown value to:', landingService.assistantId);
                    }
                    
                    // Update toggle button
                    const landingToggle = document.querySelector('[data-service-id="landing-page"].toggle-service-btn');
                    if (landingToggle) {
                        landingToggle.textContent = landingService.isActive ? 'DEACTIVATE' : 'ACTIVATE';
                        landingToggle.className = `btn ${landingService.isActive ? 'btn-secondary' : 'btn-success'} toggle-service-btn`;
                        landingToggle.dataset.isActive = !landingService.isActive;
                    }
                } else {
                    console.log('âŒ No landing service configuration found');
                    // Si no hay configuraciÃ³n, mostrar valores por defecto
                    document.getElementById('landing-assistant-name').textContent = '-';
                    document.getElementById('landing-last-updated').textContent = '-';
                    document.getElementById('landing-project').textContent = this.activeProject || '-';
                    
                    const landingSelect = document.getElementById('assistant-landing-page');
                    if (landingSelect) {
                        landingSelect.value = '';
                    }
                }

                // Update Webhook Parallel service
                const webhookService = this.serviceConfigs.find(s => s.serviceId === 'webhook-parallel');
                if (webhookService) {
                    console.log('âœ… Updating webhook service info:', webhookService);
                    
                    // Set selected assistant for webhook
                    const webhookSelect = document.getElementById('webhookAssistant');
                    if (webhookSelect) {
                        webhookSelect.value = webhookService.assistantId || '';
                        console.log('Set webhook dropdown value to:', webhookService.assistantId);
                    }
                } else {
                    console.log('âŒ No webhook service configuration found');
                    // Si no hay configuraciÃ³n, limpiar el dropdown
                    const webhookSelect = document.getElementById('webhookAssistant');
                    if (webhookSelect) {
                        webhookSelect.value = '';
                    }
                }
                
                // Mostrar informaciÃ³n del asistente activo global
                this.updateGlobalAssistantInfo();
            }

            updateGlobalAssistantInfo() {
                // Mostrar informaciÃ³n del asistente activo global
                const globalAssistant = this.assistants.find(a => a.id === this.activeAssistant);
                const globalAssistantElement = document.getElementById('globalAssistantName');
                
                if (globalAssistant && globalAssistantElement) {
                    globalAssistantElement.textContent = globalAssistant.name || 'Unnamed';
                    console.log('Asistente activo global:', globalAssistant.name);
                } else if (globalAssistantElement) {
                    globalAssistantElement.textContent = '-';
                }
            }

            async applyAssistantChange(serviceId) {
                console.log(`ðŸ”„ applyAssistantChange called with serviceId: ${serviceId}`);
                
                const selectElement = document.getElementById(`assistant-${serviceId}`);
                console.log(`ðŸ” Select element found:`, selectElement);
                
                if (!selectElement) {
                    console.error(`âŒ Select element not found for serviceId: ${serviceId}`);
                    this.showStatus(`Select element not found for service: ${serviceId}`, 'error');
                    return;
                }
                
                const selectedAssistantId = selectElement.value;
                console.log(`ðŸ“‹ Selected assistant ID: ${selectedAssistantId}`);
                
                if (!selectedAssistantId) {
                    this.showStatus('Please select an assistant first', 'error');
                    return;
                }

                const assistant = this.assistants.find(a => a.id === selectedAssistantId);
                console.log(`ðŸ” Assistant found:`, assistant);
                
                if (!assistant) {
                    this.showStatus('Assistant not found', 'error');
                    return;
                }

                try {
                    console.log(`ðŸ”„ Aplicando cambio para servicio: ${serviceId}`);
                    console.log(`ðŸ“‹ Asistente seleccionado:`, assistant);
                    
                    const response = await this.authenticatedFetch(`/api/admin/services/${serviceId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            assistantId: selectedAssistantId,
                            assistantName: assistant.name || 'Sin nombre'
                        })
                    });
                    
                    console.log(`ðŸ“¡ Response received:`, response);
                    
                    if (!response) return;

                    const data = await response.json();
                    console.log(`ðŸ“Š Response data:`, data);
                    
                    if (data.success) {
                        console.log(`âœ… Change applied successfully:`, data);
                        this.showStatus(`Assistant "${assistant.name}" applied to ${serviceId}`, 'success');
                        
                        // Add activity log
                        this.addActivity(`Assistant "${assistant.name}" applied to ${serviceId}`, 'success');
                        
                        // Reload dashboard to update assistant statuses
                        await this.loadDashboard();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error(`âŒ Error applying change:`, error);
                    this.showStatus(`Error applying change: ${error.message}`, 'error');
                }
            }

            async toggleService(serviceId, isActive) {
                try {
                    const response = await this.authenticatedFetch(`/api/admin/services/${serviceId}/toggle`, {
                        method: 'PATCH',
                        body: JSON.stringify({ isActive })
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                                         if (data.success) {
                         this.showStatus(`Service ${serviceId} ${isActive ? 'activated' : 'deactivated'}`, 'success');
                        
                        // Add activity log
                        this.addActivity(`Service ${serviceId} ${isActive ? 'activated' : 'deactivated'}`, 'success');
                        
                        // Reload dashboard to update assistant statuses
                        await this.loadDashboard();
                     } else {
                         throw new Error(data.error);
                     }
                 } catch (error) {
                     this.showStatus(`Error changing status: ${error.message}`, 'error');
                 }
            }

            async changeActiveProject(projectKey) {
                if (!projectKey) return;

                try {
                    const response = await this.authenticatedFetch('/api/admin/projects/set-active', {
                        method: 'POST',
                        body: JSON.stringify({ projectKey })
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                                         if (data.success) {
                        this.activeProject = projectKey;
                        this.showStatus(`Project changed to: ${projectKey}`, 'success');
                        this.renderProjects();
                        this.addActivity(`Project changed to ${projectKey}`, 'success');
                     } else {
                         throw new Error(data.error);
                     }
                 } catch (error) {
                    this.showStatus(`Error changing project: ${error.message}`, 'error');
                }
            }

            addActivity(text, type) {
                const activityList = document.getElementById('recentActivity');
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });

                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-indicator ${type}"></div>
                    <div class="activity-content">
                        <div class="activity-text">${text}</div>
                        <div class="activity-time">Today at ${timeString}</div>
                    </div>
                `;

                activityList.insertBefore(activityItem, activityList.firstChild);
                
                // Keep only last 6 activities
                while (activityList.children.length > 6) {
                    activityList.removeChild(activityList.lastChild);
                 }
            }

            showStatus(message, type) {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.textContent = message;
                statusDiv.className = `status-message status-${type}`;
                statusDiv.style.display = 'block';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }

            async logout() {
                try {
                    // Llamar al endpoint de logout
                    await this.authenticatedFetch('/api/auth/logout', {
                        method: 'POST'
                    });
                } catch (error) {
                    console.log('Error en logout:', error);
                } finally {
                    // Limpiar token y redirigir
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                }
            }

                         setupEventListeners() {
                // Event listener para logout
                document.getElementById('logoutBtn')?.addEventListener('click', () => {
                    this.logout();
                });
                
                // Event listener para cambiar proyecto activo
                document.getElementById('activeProject')?.addEventListener('change', (e) => {
                    this.changeActiveProject(e.target.value);
                });
                
                // Event listeners para servidor remoto
                document.getElementById('remoteServerUrl')?.addEventListener('change', (e) => {
                    this.remoteServerUrl = e.target.value;
                    this.loadRemoteProjects();
                });
                
                document.getElementById('remoteActiveProject')?.addEventListener('change', (e) => {
                    this.changeRemoteProject(e.target.value);
                });

                // Ticket control event listeners
                document.getElementById('disableTicketBtn')?.addEventListener('click', () => {
                    this.disableTicketAssistant();
                });

                document.getElementById('enableTicketBtn')?.addEventListener('click', () => {
                    this.enableTicketAssistant();
                });

                document.getElementById('checkTicketBtn')?.addEventListener('click', () => {
                    this.checkTicketStatus();
                });

                document.getElementById('refreshDisabledBtn')?.addEventListener('click', () => {
                    this.loadDisabledTickets();
                });

                // Webhook configuration event listeners
                document.getElementById('saveWebhookConfigBtn')?.addEventListener('click', () => {
                    this.saveWebhookConfiguration();
                });

                document.getElementById('testWebhookBtn')?.addEventListener('click', () => {
                    this.testWebhook();
                });

                document.getElementById('disableWebhookBtn')?.addEventListener('click', () => {
                    this.disableWebhook();
                });

                // Saved webhooks event listeners
                document.getElementById('createNewWebhookBtn')?.addEventListener('click', () => {
                    this.showNewWebhookFields();
                });

                document.getElementById('cancelNewWebhookBtn')?.addEventListener('click', () => {
                    this.hideNewWebhookFields();
                    this.clearWebhookForm();
                });

                document.getElementById('saveWebhookBtn')?.addEventListener('click', () => {
                    this.saveWebhook();
                });

                document.getElementById('deleteWebhookBtn')?.addEventListener('click', () => {
                    this.deleteSavedWebhook();
                });

                // Event listener for saved webhook selection
                document.getElementById('savedWebhookSelect')?.addEventListener('change', (e) => {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    if (selectedOption.value) {
                        // Fill the form with selected webhook data
                        document.getElementById('webhookUrl').value = selectedOption.dataset.url || '';
                        document.getElementById('webhookName').value = selectedOption.dataset.name || '';
                        document.getElementById('webhookDescription').value = selectedOption.dataset.description || '';
                        document.getElementById('deleteWebhookBtn').style.display = 'inline-block';
                        // Hide new webhook fields when selecting a saved webhook
                        this.hideNewWebhookFields();
                    } else {
                        // Clear form and hide delete button
                        this.clearWebhookForm();
                    }
                });
             }

             setupDynamicEventListeners() {
                 // Event listeners para botones de aplicar cambio
                 document.querySelectorAll('.apply-change-btn').forEach(btn => {
                     // Remove existing listeners to avoid duplicates
                     btn.removeEventListener('click', this.handleApplyChange);
                     btn.addEventListener('click', this.handleApplyChange.bind(this));
                 });

                 // Event listeners para botones de toggle
                 document.querySelectorAll('.toggle-service-btn').forEach(btn => {
                     // Remove existing listeners to avoid duplicates
                     btn.removeEventListener('click', this.handleToggleService);
                     btn.addEventListener('click', this.handleToggleService.bind(this));
                 });
            }

            handleApplyChange(e) {
                console.log(`ðŸ”„ handleApplyChange called`);
                console.log(`ðŸ” Event target:`, e.target);
                console.log(`ðŸ” Dataset:`, e.target.dataset);
                
                const serviceId = e.target.dataset.serviceId;
                console.log(`ðŸ” Service ID: ${serviceId}`);
                
                this.applyAssistantChange(serviceId);
            }

            handleToggleService(e) {
                const serviceId = e.target.dataset.serviceId;
                const isActive = e.target.dataset.isActive === 'true';
                this.toggleService(serviceId, isActive);
            }

            // === REMOTE SERVER FUNCTIONS ===

            async loadRemoteProjects() {
                try {
                    const response = await fetch(`${this.remoteServerUrl}/api/projects/available`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.remoteProjects = data.availableProjects || [];
                        this.renderRemoteProjects();
                        
                        // Cargar el proyecto activo despuÃ©s de renderizar los proyectos
                        await this.loadRemoteActiveProject();
                    } else {
                        throw new Error(data.error || 'Failed to load remote projects');
                    }
                } catch (error) {
                    console.error('Error loading remote projects:', error);
                    this.showStatus(`Error loading remote projects: ${error.message}`, 'error');
                }
            }

            async loadRemoteActiveProject() {
                try {
                    const response = await fetch(`${this.remoteServerUrl}/api/projects/current`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.remoteActiveProject = data.currentProject?.key || '';
                        this.updateRemoteProjectInfo();
                        
                        // Actualizar el dropdown para mostrar el proyecto seleccionado
                        const select = document.getElementById('remoteActiveProject');
                        if (select && this.remoteActiveProject) {
                            select.value = this.remoteActiveProject;
                        }
                        
                        console.log(`âœ… Remote active project loaded: ${this.remoteActiveProject}`);
                    }
                } catch (error) {
                    console.error('Error loading remote active project:', error);
                }
            }

            renderRemoteProjects() {
                const select = document.getElementById('remoteActiveProject');
                
                if (this.remoteProjects.length === 0) {
                    select.innerHTML = '<option value="">No remote projects available</option>';
                    return;
                }

                select.innerHTML = this.remoteProjects.map(project => `
                    <option value="${project.key}" ${project.key === this.remoteActiveProject ? 'selected' : ''}>
                        ${project.name} (${project.key})
                    </option>
                `).join('');
                
                console.log(`âœ… Remote projects rendered: ${this.remoteProjects.length} projects, active: ${this.remoteActiveProject}`);
            }

            updateRemoteProjectInfo() {
                const currentProjectName = document.getElementById('remoteCurrentProjectName');
                const currentProjectKey = document.getElementById('remoteCurrentProjectKey');
                
                if (this.remoteActiveProject) {
                    const project = this.remoteProjects.find(p => p.key === this.remoteActiveProject);
                    currentProjectName.textContent = project ? project.name : '-';
                    currentProjectKey.textContent = this.remoteActiveProject;
                } else {
                    currentProjectName.textContent = '-';
                    currentProjectKey.textContent = '-';
                }
            }

            async changeRemoteProject(projectKey) {
                if (!projectKey) {
                    this.showStatus('Please select a remote project first', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${this.remoteServerUrl}/api/projects/set-active`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectKey })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.remoteActiveProject = projectKey;
                        this.updateRemoteProjectInfo();
                        this.showStatus(`Remote project changed to: ${projectKey}`, 'success');
                        this.addActivity(`Remote project changed to ${projectKey}`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to change remote project');
                    }
                } catch (error) {
                    console.error('Error changing remote project:', error);
                    this.showStatus(`Error changing remote project: ${error.message}`, 'error');
                }
            }

            // === TICKET CONTROL METHODS ===

            async loadDisabledTickets() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/tickets/disabled');
                    if (!response) return;
                    const data = await response.json();

                    if (data.success) {
                        this.renderDisabledTickets(data.data.disabledTickets);
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error loading disabled tickets:', error);
                    this.showStatus(`Error loading disabled tickets: ${error.message}`, 'error');
                }
            }

            renderDisabledTickets(disabledTickets) {
                const container = document.getElementById('disabledTicketsList');
                
                if (disabledTickets.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><span>No tickets with disabled assistants</span></div>';
                    return;
                }

                container.innerHTML = disabledTickets.map(ticket => `
                    <div class="disabled-ticket-item">
                        <div class="ticket-info">
                            <div class="ticket-key">${ticket.issueKey}</div>
                            <div class="ticket-details">
                                <span class="ticket-reason">${ticket.reason}</span>
                                <span class="ticket-date">${new Date(ticket.disabledAt).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="ticket-actions">
                            <button class="btn btn-sm btn-success enable-ticket-btn" data-issue-key="${ticket.issueKey}">
                                <i class="fas fa-check"></i> Enable
                            </button>
                        </div>
                    </div>
                `).join('');

                // Add event listeners for enable buttons
                document.querySelectorAll('.enable-ticket-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const issueKey = e.target.dataset.issueKey;
                        this.enableTicketAssistant(issueKey);
                    });
                });
            }

            async disableTicketAssistant() {
                const issueKey = document.getElementById('ticketIssueKey').value.trim();
                const reason = document.getElementById('disableReason').value.trim();

                if (!issueKey) {
                    this.showStatus('Please enter a ticket key', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/tickets/${issueKey}/disable`, {
                        method: 'POST',
                        body: JSON.stringify({ reason })
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus(`AI Assistant disabled for ticket ${issueKey}`, 'success');
                        this.addActivity(`AI Assistant disabled for ticket ${issueKey}`, 'success');
                        
                        // Clear form
                        document.getElementById('ticketIssueKey').value = '';
                        document.getElementById('disableReason').value = '';
                        
                        // Reload disabled tickets
                        await this.loadDisabledTickets();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error disabling ticket assistant:', error);
                    this.showStatus(`Error disabling assistant: ${error.message}`, 'error');
                }
            }

            async enableTicketAssistant(issueKey) {
                if (!issueKey) {
                    issueKey = document.getElementById('ticketIssueKey').value.trim();
                }

                if (!issueKey) {
                    this.showStatus('Please enter a ticket key', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/tickets/${issueKey}/enable`, {
                        method: 'POST'
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus(`AI Assistant enabled for ticket ${issueKey}`, 'success');
                        this.addActivity(`AI Assistant enabled for ticket ${issueKey}`, 'success');
                        
                        // Clear form if it was used
                        if (document.getElementById('ticketIssueKey').value === issueKey) {
                            document.getElementById('ticketIssueKey').value = '';
                            document.getElementById('disableReason').value = '';
                        }
                        
                        // Reload disabled tickets
                        await this.loadDisabledTickets();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error enabling ticket assistant:', error);
                    this.showStatus(`Error enabling assistant: ${error.message}`, 'error');
                }
            }

            async checkTicketStatus() {
                const issueKey = document.getElementById('ticketIssueKey').value.trim();

                if (!issueKey) {
                    this.showStatus('Please enter a ticket key', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/tickets/${issueKey}/status`);
                    if (!response) return;
                    const data = await response.json();
                    
                    if (data.success) {
                        const status = data.data.isDisabled ? 'DISABLED' : 'ENABLED';
                        const reason = data.data.ticketInfo?.reason || 'No reason provided';
                        const disabledAt = data.data.ticketInfo?.disabledAt ? 
                            new Date(data.data.ticketInfo.disabledAt).toLocaleString() : 'Unknown';
                        
                        let message = `Ticket ${issueKey} status: ${status}`;
                        if (data.data.isDisabled) {
                            message += `\nReason: ${reason}\nDisabled at: ${disabledAt}`;
                        }
                        
                        this.showStatus(message, data.data.isDisabled ? 'warning' : 'success');
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error checking ticket status:', error);
                    this.showStatus(`Error checking status: ${error.message}`, 'error');
                }
            }

            // === WEBHOOK CONFIGURATION METHODS ===

            async saveWebhookConfiguration() {
                const webhookUrl = document.getElementById('webhookUrl').value.trim();
                const webhookAssistant = document.getElementById('webhookAssistant').value;

                if (!webhookUrl) {
                    this.showStatus('Please enter a webhook URL', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch('/api/admin/webhook/configure', {
                        method: 'POST',
                        body: JSON.stringify({
                            webhookUrl: webhookUrl,
                            assistantId: webhookAssistant || null
                        })
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('Webhook configuration saved successfully', 'success');
                        this.addActivity('Webhook configuration updated', 'success');
                        this.updateWebhookStatus();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error saving webhook configuration:', error);
                    this.showStatus(`Error saving webhook: ${error.message}`, 'error');
                }
            }

            async testWebhook() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/webhook/test', {
                        method: 'POST'
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('Webhook test successful', 'success');
                        this.addActivity('Webhook test completed successfully', 'success');
                        document.getElementById('webhookLastTest').textContent = new Date().toLocaleString();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error testing webhook:', error);
                    this.showStatus(`Webhook test failed: ${error.message}`, 'error');
                }
            }

            async disableWebhook() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/webhook/disable', {
                        method: 'POST'
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('Webhook disabled successfully', 'success');
                        this.addActivity('Webhook disabled', 'warning');
                        this.updateWebhookStatus();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error disabling webhook:', error);
                    this.showStatus(`Error disabling webhook: ${error.message}`, 'error');
                }
            }

            async updateWebhookStatus() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/webhook/status');
                    if (!response) return;
                    const data = await response.json();

                    if (data.success) {
                        const status = data.data.isEnabled ? 'Enabled' : 'Disabled';
                        const url = data.data.webhookUrl ? 'Configured' : 'Not configured';
                        const isJiraAutomation = data.data.webhookUrl?.includes('api-private.atlassian.com/automation/webhooks');
                        const webhookType = isJiraAutomation ? 'Jira Automation' : 'REST';
                        
                        document.getElementById('webhookStatus').textContent = `${status} - ${url}`;
                        document.getElementById('webhookType').textContent = webhookType;
                        document.getElementById('webhookUrl').value = data.data.webhookUrl || '';
                        
                        // Check token status (simplified check)
                        const hasToken = data.data.webhookUrl?.includes('api-private.atlassian.com');
                        document.getElementById('webhookTokenStatus').textContent = hasToken ? 'Required for Jira Automation' : 'Not required';
                        
                        // Update assistant dropdown only if it's empty or if we're explicitly updating webhook config
                        const webhookAssistantSelect = document.getElementById('webhookAssistant');
                        if (webhookAssistantSelect) {
                            // Only update if dropdown is empty or if we have a valid assistantId from webhook config
                            if (!webhookAssistantSelect.value || data.data.assistantId) {
                                webhookAssistantSelect.value = data.data.assistantId || '';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating webhook status:', error);
                }
            }

            // === SAVED WEBHOOKS METHODS ===

            async loadSavedWebhooks() {
                try {
                    console.log('ðŸ”„ Loading saved webhooks...');
                    const response = await this.authenticatedFetch('/api/admin/webhooks/saved');
                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.populateSavedWebhooksDropdown(data.data);
                        console.log(`âœ… Loaded ${data.data.length} saved webhooks`);
                    }
                } catch (error) {
                    console.error('Error loading saved webhooks:', error);
                }
            }

            populateSavedWebhooksDropdown(webhooks) {
                const select = document.getElementById('savedWebhookSelect');
                if (!select) return;

                // Clear existing options except the first one
                select.innerHTML = '<option value="">Choose a saved webhook...</option>';

                webhooks.forEach(webhook => {
                    const option = document.createElement('option');
                    option.value = webhook.id;
                    option.textContent = `${webhook.name} - ${webhook.url.substring(0, 50)}...`;
                    option.dataset.url = webhook.url;
                    option.dataset.name = webhook.name;
                    option.dataset.description = webhook.description || '';
                    select.appendChild(option);
                });
            }

            async saveWebhook() {
                try {
                    const name = document.getElementById('webhookName').value.trim();
                    const url = document.getElementById('webhookUrl').value.trim();
                    const description = document.getElementById('webhookDescription').value.trim();

                    if (!name || !url) {
                        this.showStatus('Name and URL are required', 'error');
                        return;
                    }

                    console.log('ðŸ”„ Saving webhook...');
                    const response = await this.authenticatedFetch('/api/admin/webhooks/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, url, description })
                    });

                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Webhook saved successfully', 'success');
                        this.addActivity(`Webhook "${name}" saved`, 'success');
                        await this.loadSavedWebhooks(); // Reload the dropdown
                        this.clearWebhookForm(); // Clear form after saving
                        this.hideNewWebhookFields(); // Hide the new webhook fields
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error saving webhook:', error);
                    this.showStatus(`Error saving webhook: ${error.message}`, 'error');
                }
            }

            async deleteSavedWebhook() {
                try {
                    const select = document.getElementById('savedWebhookSelect');
                    const selectedId = select.value;

                    if (!selectedId) {
                        this.showStatus('Please select a webhook to delete', 'error');
                        return;
                    }

                    if (!confirm('Are you sure you want to delete this saved webhook?')) {
                        return;
                    }

                    console.log('ðŸ”„ Deleting saved webhook...');
                    const response = await this.authenticatedFetch(`/api/admin/webhooks/${selectedId}`, {
                        method: 'DELETE'
                    });

                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Webhook deleted successfully', 'success');
                        this.addActivity(`Webhook deleted`, 'warning');
                        await this.loadSavedWebhooks(); // Reload the dropdown
                        this.clearWebhookForm();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error deleting webhook:', error);
                    this.showStatus(`Error deleting webhook: ${error.message}`, 'error');
                }
            }

            clearWebhookForm() {
                document.getElementById('webhookUrl').value = '';
                document.getElementById('webhookName').value = '';
                document.getElementById('webhookDescription').value = '';
                document.getElementById('savedWebhookSelect').value = '';
                document.getElementById('deleteWebhookBtn').style.display = 'none';
            }

            showNewWebhookFields() {
                document.getElementById('newWebhookFields').style.display = 'block';
                document.getElementById('newWebhookDescription').style.display = 'block';
                document.getElementById('saveWebhookBtn').style.display = 'inline-block';
                document.getElementById('cancelNewWebhookBtn').style.display = 'inline-block';
                document.getElementById('createNewWebhookBtn').style.display = 'none';
            }

            hideNewWebhookFields() {
                document.getElementById('newWebhookFields').style.display = 'none';
                document.getElementById('newWebhookDescription').style.display = 'none';
                document.getElementById('saveWebhookBtn').style.display = 'none';
                document.getElementById('cancelNewWebhookBtn').style.display = 'none';
                document.getElementById('createNewWebhookBtn').style.display = 'inline-block';
            }

            // === SECTION NAVIGATION METHODS ===

            setupSectionNavigation() {
                const navButtons = document.querySelectorAll('.section-nav-btn');
                navButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const section = e.target.dataset.section;
                        this.showSection(section);
                    });
                });
            }

            showSection(sectionName) {
                console.log(`ðŸ”„ Switching to section: ${sectionName}`);
                
                // Hide all sections
                const sections = document.querySelectorAll('.section-content');
                console.log(`ðŸ“‹ Found ${sections.length} sections`);
                sections.forEach(section => {
                    section.classList.remove('active');
                    console.log(`âŒ Hiding section: ${section.id}`);
                });

                // Show selected section
                const targetSection = document.getElementById(`${sectionName}-section`);
                if (targetSection) {
                    targetSection.classList.add('active');
                    console.log(`âœ… Showing section: ${targetSection.id}`);
                } else {
                    console.error(`âŒ Section not found: ${sectionName}-section`);
                }

                // Update navigation buttons
                const navButtons = document.querySelectorAll('.section-nav-btn');
                navButtons.forEach(button => {
                    button.classList.remove('active');
                    if (button.dataset.section === sectionName) {
                        button.classList.add('active');
                    }
                });

                console.log(`âœ… Switched to ${sectionName} section`);
            }

            // === STATUS-BASED DISABLE METHODS ===

            async loadStatusDisableConfig() {
                try {
                    console.log('ðŸ”„ Loading status disable configuration...');
                    
                    // Load current configuration
                    const configResponse = await this.authenticatedFetch('/api/admin/status-disable/config');
                    if (!configResponse) {
                        console.error('âŒ No config response received');
                        return;
                    }
                    const configData = await configResponse.json();
                    console.log('ðŸ“Š Config data:', configData);

                    // Load available statuses
                    const statusesResponse = await this.authenticatedFetch('/api/admin/statuses/available');
                    if (!statusesResponse) {
                        console.error('âŒ No statuses response received');
                        return;
                    }
                    const statusesData = await statusesResponse.json();
                    console.log('ðŸ“‹ Statuses data:', statusesData);

                    if (configData.success && statusesData.success) {
                        console.log('âœ… Both requests successful, populating UI...');
                        this.populateStatusCheckboxes(statusesData.data);
                        this.updateStatusDisableUI(configData.data);
                    } else {
                        console.error('âŒ One or both requests failed:', {
                            configSuccess: configData.success,
                            statusesSuccess: statusesData.success
                        });
                    }
                } catch (error) {
                    console.error('âŒ Error loading status disable config:', error);
                }
            }

            populateStatusCheckboxes(statuses) {
                console.log('ðŸ“‹ Populating status checkboxes with:', statuses);
                
                const container = document.getElementById('statusCheckboxes');
                if (!container) {
                    console.error('âŒ statusCheckboxes container not found');
                    return;
                }
                
                container.innerHTML = '';

                statuses.forEach(status => {
                    console.log('ðŸ”² Creating checkbox for status:', status);
                    
                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = 'status-checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `status_${status.id}`;
                    checkbox.value = status.name;
                    checkbox.className = 'status-checkbox';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `status_${status.id}`;
                    label.textContent = status.name;
                    label.className = 'status-label';
                    
                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(label);
                    container.appendChild(checkboxContainer);
                });
                
                console.log(`âœ… Created ${statuses.length} status checkboxes`);
            }

            updateStatusDisableUI(config) {
                console.log('ðŸ”„ Updating status disable UI with config:', config);
                
                const enabledCheckbox = document.getElementById('statusDisableEnabled');
                const statusSelectionGroup = document.getElementById('statusSelectionGroup');
                const statusDisableStatus = document.getElementById('statusDisableStatus');
                const triggerStatusesList = document.getElementById('triggerStatusesList');

                if (!enabledCheckbox || !statusSelectionGroup || !statusDisableStatus || !triggerStatusesList) {
                    console.error('âŒ One or more UI elements not found');
                    return;
                }

                enabledCheckbox.checked = config.isEnabled;
                statusSelectionGroup.style.display = config.isEnabled ? 'block' : 'none';
                
                statusDisableStatus.textContent = config.isEnabled ? 'Enabled' : 'Disabled';
                triggerStatusesList.textContent = config.triggerStatuses.length > 0 
                    ? config.triggerStatuses.join(', ') 
                    : 'None';

                console.log('ðŸ”² Checking status checkboxes for:', config.triggerStatuses);
                // Check the appropriate status checkboxes
                config.triggerStatuses.forEach(statusName => {
                    const checkbox = document.querySelector(`input[value="${statusName}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`âœ… Checked checkbox for status: ${statusName}`);
                    } else {
                        console.log(`âŒ Checkbox not found for status: ${statusName}`);
                    }
                });
                
                console.log('âœ… Status disable UI updated');
            }

            async saveStatusDisableConfig() {
                console.log('ðŸ”§ Saving status disable configuration...');
                
                const isEnabled = document.getElementById('statusDisableEnabled').checked;
                const selectedStatuses = Array.from(document.querySelectorAll('.status-checkbox:checked'))
                    .map(checkbox => checkbox.value);

                console.log('ðŸ“Š Configuration data:', {
                    isEnabled,
                    selectedStatuses,
                    totalCheckboxes: document.querySelectorAll('.status-checkbox').length,
                    checkedCheckboxes: document.querySelectorAll('.status-checkbox:checked').length
                });

                try {
                    const response = await this.authenticatedFetch('/api/admin/status-disable/configure', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            isEnabled: isEnabled,
                            triggerStatuses: selectedStatuses
                        })
                    });
                    
                    console.log('ðŸ“¡ Response received:', response);
                    if (!response) {
                        console.error('âŒ No response received');
                        return;
                    }

                    const data = await response.json();
                    console.log('ðŸ“Š Response data:', data);
                    
                    if (data.success) {
                        console.log('âœ… Configuration saved successfully');
                        this.showStatus('Status-based disable configuration saved successfully', 'success');
                        this.addActivity('Status-based disable configuration updated', 'success');
                        this.updateStatusDisableUI(data.data);
                    } else {
                        console.error('âŒ Configuration save failed:', data.error);
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('âŒ Error saving status disable configuration:', error);
                    this.showStatus(`Error saving configuration: ${error.message}`, 'error');
                }
            }
        }

                 // Variable global para el dashboard
         let dashboard;
 

         // Inicializar cuando el DOM estÃ© listo
         document.addEventListener('DOMContentLoaded', function() {
             dashboard = new CEODashboard();
             
             // Event listener para el checkbox de status disable
             document.getElementById('statusDisableEnabled').addEventListener('change', function() {
                 const statusSelectionGroup = document.getElementById('statusSelectionGroup');
                 statusSelectionGroup.style.display = this.checked ? 'block' : 'none';
             });
             
             // Event listeners para los botones de status disable
             document.getElementById('saveStatusDisableBtn').addEventListener('click', function() {
                 if (dashboard) {
                     dashboard.saveStatusDisableConfig();
                 }
             });
             
             document.getElementById('loadStatusDisableBtn').addEventListener('click', function() {
                 if (dashboard) {
                     dashboard.loadStatusDisableConfig();
                 }
             });
         });
    </script>
</body>
</html>